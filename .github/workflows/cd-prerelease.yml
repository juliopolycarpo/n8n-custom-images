name: "CD: Pre-release"

on:
  schedule:
    # Twice daily: 3:10 AM and 3:10 PM UTC
    - cron: "10 3,15 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if release already exists"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

concurrency:
  group: cd-prerelease
  cancel-in-progress: true

jobs:
  # ============================================================
  # Detect latest pre-release from npm registry
  # ============================================================
  detect-version:
    name: Detect Latest Pre-release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.fetch.outputs.version }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest pre-release version from npm
        id: fetch
        run: ./scripts/fetch_latest_prerelease.sh

      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.fetch.outputs.version }}
          FORCE: ${{ inputs.force_build || 'false' }}
          RELEASE_TAG_PREFIX: n8n-pre-v
        run: ./scripts/check_release_exists.sh

  # ============================================================
  # Build multi-arch images and push to registries
  # ============================================================
  build-images:
    name: Build Images
    needs: [detect-version]
    if: needs.detect-version.outputs.should_build == 'true'
    uses: ./.github/workflows/cd-build.yml
    with:
      version: ${{ needs.detect-version.outputs.version }}
      release_type: prerelease
      push: true
    secrets:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # ============================================================
  # Publish GitHub Release with SHA256 checksums
  # ============================================================
  publish-release:
    name: Publish Release
    needs: [detect-version, build-images]
    uses: ./.github/workflows/cd-release.yml
    with:
      version: ${{ needs.detect-version.outputs.version }}
      release_type: prerelease
    secrets:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
