name: "CD: Pre-release"

on:
  schedule:
    # Twice daily: 3:10 AM and 3:10 PM UTC
    - cron: "10 3,15 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if release already exists"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

concurrency:
  group: cd-prerelease
  cancel-in-progress: true

jobs:
  # ============================================================
  # Detect latest pre-release
  # ============================================================
  detect:
    name: Detect
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.fetch.outputs.version }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest pre-release
        id: fetch
        run: ./scripts/fetch_latest_prerelease.sh

      - name: Check if already built
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.fetch.outputs.version }}
          FORCE: ${{ inputs.force_build || 'false' }}
          RELEASE_TAG_PREFIX: n8n-pre-v
        run: ./scripts/check_release_exists.sh

  # ============================================================
  # Build and push images
  # ============================================================
  build:
    name: Build
    needs: [detect]
    if: needs.detect.outputs.should_build == 'true'
    uses: ./.github/workflows/cd-build.yml
    with:
      version: ${{ needs.detect.outputs.version }}
      release_type: prerelease
      push: true
    secrets:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # ============================================================
  # Create GitHub Release
  # ============================================================
  release:
    name: Release
    needs: [detect, build]
    uses: ./.github/workflows/cd-release.yml
    with:
      version: ${{ needs.detect.outputs.version }}
      release_type: prerelease
