name: "Release: Stable"

on:
  schedule:
    # Daily at 3:10 AM UTC
    - cron: "10 3 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if release already exists"
        type: boolean
        default: false

concurrency:
  group: release-stable
  cancel-in-progress: true

jobs:
  detect:
    name: Detect Stable Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.fetch.outputs.version }}
      version_minor: ${{ steps.fetch.outputs.version_minor }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest stable release
        id: fetch
        run: ./scripts/fetch_latest_stable.sh

      - name: Check if already built
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.fetch.outputs.version }}
          FORCE: ${{ inputs.force_build || 'false' }}
          RELEASE_TAG_PREFIX: n8n-v
        run: ./scripts/check_release_exists.sh

  build:
    name: Build Stable
    needs: [detect]
    if: needs.detect.outputs.should_build == 'true'
    uses: ./.github/workflows/build-and-release.yml
    with:
      release_type: stable
      version: ${{ needs.detect.outputs.version }}
      version_minor: ${{ needs.detect.outputs.version_minor }}
    secrets:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
