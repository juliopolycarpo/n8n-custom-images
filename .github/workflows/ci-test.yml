name: Test

on:
  workflow_call:
    inputs:
      image_id:
        description: "Image ID to test (e.g., n8n-python)"
        type: string
        required: false
        default: ""

permissions:
  contents: read

jobs:
  # ============================================================
  # Load image matrix from images.json
  # ============================================================
  prepare:
    name: Prepare Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Load images.json
        id: matrix
        run: |
          if [ -n "${{ inputs.image_id }}" ]; then
            matrix=$(jq -c --arg id "${{ inputs.image_id }}" '{include: [.images[] | select(.id == $id)]}' images/images.json)
          else
            matrix=$(jq -c '{include: .images}' images/images.json)
          fi
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  # ============================================================
  # Build and test each image
  # ============================================================
  test:
    name: "Test ${{ matrix.id }}"
    runs-on: ubuntu-latest
    needs: [prepare]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          load: true
          tags: ${{ matrix.id }}:test

      - name: Test - Container starts
        run: |
          docker run --rm -d --name test-container ${{ matrix.id }}:test
          sleep 5
          docker logs test-container
          docker stop test-container

      - name: Test - Python available
        if: contains(matrix.id, 'python')
        run: |
          docker run --rm --entrypoint="" ${{ matrix.id }}:test python3 --version
          docker run --rm --entrypoint="" ${{ matrix.id }}:test pip3 --version

      - name: Test - n8n version
        run: |
          docker run --rm --entrypoint="" ${{ matrix.id }}:test n8n --version
