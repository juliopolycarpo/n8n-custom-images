name: "CI: Image Validation"

on:
  workflow_call:
    inputs:
      image_id:
        description: "Image ID to test (e.g., n8n-python)"
        type: string
        required: false
        default: ""

permissions:
  contents: read

jobs:
  # ============================================================
  # Generate dynamic test matrix from images.json manifest
  # ============================================================
  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Load image definitions from manifest
        id: matrix
        run: |
          if [ -n "${{ inputs.image_id }}" ]; then
            matrix=$(jq -c --arg id "${{ inputs.image_id }}" '{include: [.images[] | select(.id == $id)]}' images/images.json)
          else
            matrix=$(jq -c '{include: .images}' images/images.json)
          fi
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  # ============================================================
  # Build and validate each image
  # ============================================================
  validate-image:
    name: "Validate ${{ matrix.id }}"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [generate-matrix]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for validation
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          load: true
          tags: ${{ matrix.id }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify container lifecycle (start/stop)
        run: |
          docker run --rm -d --name test-container ${{ matrix.id }}:test
          sleep 5
          docker logs test-container
          docker stop test-container

      - name: Verify Python 3 and pip are installed
        if: contains(matrix.id, 'python')
        run: |
          docker run --rm --entrypoint="" ${{ matrix.id }}:test python3 --version
          docker run --rm --entrypoint="" ${{ matrix.id }}:test pip3 --version

      - name: Verify n8n CLI responds correctly
        run: |
          docker run --rm --entrypoint="" ${{ matrix.id }}:test n8n --version
